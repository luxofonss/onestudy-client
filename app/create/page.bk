"use client";

import type React from "react";

import { useState, useRef, useEffect } from "react";
import {
  Plus,
  Edit,
  Trash2,
  Eye,
  Save,
  X,
  Play,
  RotateCcw,
  ArrowLeft,
  ArrowRight,
  Volume2,
  ImageIcon,
  ChevronUp,
  ChevronDown,
  Library,
  FileText,
  CheckCircle,
  Clock,
  Shuffle,
  Timer,
  Settings,
} from "lucide-react";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from "@/components/ui/dialog";
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
  AlertDialogTrigger,
} from "@/components/ui/alert-dialog";
import { RadioGroup, RadioGroupItem } from "@/components/ui/radio-group";
import { Progress } from "@/components/ui/progress";
import { Badge } from "@/components/ui/badge";
import { Slider } from "@/components/ui/slider";
import { toast } from "@/components/ui/use-toast";
import { Switch } from "@/components/ui/switch";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { useAuth } from "@/lib/hooks/use-auth";
import { useRouter } from "next/navigation";
import { withAuth } from "@/lib/hooks/with-auth";

interface Question {
  id: string;
  type:
    | "multiple-choice"
    | "pronunciation"
    | "fill-in-the-blank"
    | "true-false"
    | "listening";
  text: string;
  options?: { text: string; isCorrect: boolean }[];
  pronunciationText?: string;
  fillInBlanks?: {
    text: string;
    blanks: { position: number; answer: string }[];
  };
  trueFalseAnswer?: boolean;
  audioUrl?: string;
  imageUrl?: string;
  maxListeningTime?: number;
  points: number;
  difficulty: "beginner" | "intermediate" | "advanced";
  category: string;
  createdAt: string;
  updatedAt: string;
}

interface TestData {
  id: string;
  name: string;
  description: string;
  questions: Question[];
  createdAt: string;
  updatedAt: string;
  totalPoints: number;
  estimatedDuration: number;
  tags: string[];
  isPublic: boolean;
  authorId: string;
  version: number;
  // Enhanced quiz settings
  navigationMode: "sequential" | "back-only" | "free-navigation";
  hasTimer: boolean;
  timeLimit: number; // in minutes
  warningTime: number; // minutes before end to show warning
  allowQuestionPicker: boolean;
  shuffleQuestions: boolean;
  shuffleAnswers: boolean;
  showProgress: boolean;
  allowPause: boolean;
  maxAttempts: number;
  passingScore: number;
}

interface SavedTestMetadata {
  testId: string;
  questionCount: number;
  totalPoints: number;
  categories: string[];
  difficulties: string[];
  questionTypes: string[];
  hasMultimedia: boolean;
  estimatedDuration: number;
  lastSaved: string;
}

function CreateTestPage() {
  const { isAuthenticated } = useAuth();
  const router = useRouter();

  useEffect(() => {
    if (!isAuthenticated) {
      router.push("/auth");
    }
  }, [isAuthenticated]);

  const [testData, setTestData] = useState<TestData>({
    id: `test_${Date.now()}`,
    name: "",
    description: "",
    questions: [],
    createdAt: new Date().toISOString(),
    updatedAt: new Date().toISOString(),
    totalPoints: 0,
    estimatedDuration: 0,
    tags: [],
    isPublic: false,
    authorId: "user_123",
    version: 1,
    // Enhanced quiz settings with defaults
    navigationMode: "free-navigation",
    hasTimer: false,
    timeLimit: 30,
    warningTime: 5,
    allowQuestionPicker: true,
    shuffleQuestions: false,
    shuffleAnswers: false,
    showProgress: true,
    allowPause: true,
    maxAttempts: 3,
    passingScore: 70,
  });

  const [isModalOpen, setIsModalOpen] = useState(false);
  const [isPreviewOpen, setIsPreviewOpen] = useState(false);
  const [isLibraryOpen, setIsLibraryOpen] = useState(false);
  const [editingQuestion, setEditingQuestion] = useState<Question | null>(null);
  const [currentQuestion, setCurrentQuestion] = useState<Partial<Question>>({
    type: "multiple-choice",
    text: "",
    options: [
      { text: "", isCorrect: false },
      { text: "", isCorrect: false },
    ],
    points: 1,
    difficulty: "beginner",
    category: "General",
  });
  const [errors, setErrors] = useState<Record<string, string>>({});
  const [uploadedFiles, setUploadedFiles] = useState<{ [key: string]: File }>(
    {}
  );
  const [isSaving, setIsSaving] = useState(false);
  const [lastSaved, setLastSaved] = useState<Date | null>(null);
  const [autoSaveEnabled, setAutoSaveEnabled] = useState(true);

  // Preview state
  const [previewStarted, setPreviewStarted] = useState(false);
  const [previewCurrentQuestion, setPreviewCurrentQuestion] = useState(0);
  const [previewProgress, setPreviewProgress] = useState(0);
  const [previewSelectedAnswer, setPreviewSelectedAnswer] = useState("");
  const [previewAnswers, setPreviewAnswers] = useState<Record<number, string>>(
    {}
  );
  const [previewTimeRemaining, setPreviewTimeRemaining] = useState(0);

  // Question Library
  const [questionLibrary] = useState<Question[]>([
    {
      id: "lib1",
      type: "multiple-choice",
      text: "What is the past tense of 'go'?",
      options: [
        { text: "went", isCorrect: true },
        { text: "goed", isCorrect: false },
        { text: "gone", isCorrect: false },
        { text: "going", isCorrect: false },
      ],
      points: 1,
      difficulty: "beginner",
      category: "Grammar",
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString(),
    },
    {
      id: "lib2",
      type: "fill-in-the-blank",
      text: "I _____ to the store yesterday.",
      fillInBlanks: {
        text: "I _____ to the store yesterday.",
        blanks: [{ position: 2, answer: "went" }],
      },
      points: 2,
      difficulty: "intermediate",
      category: "Grammar",
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString(),
    },
    {
      id: "lib3",
      type: "true-false",
      text: "The word 'beautiful' is an adjective.",
      trueFalseAnswer: true,
      points: 1,
      difficulty: "beginner",
      category: "Vocabulary",
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString(),
    },
  ]);

  const fileInputRef = useRef<HTMLInputElement>(null);
  const audioInputRef = useRef<HTMLInputElement>(null);

  const [activeTab, setActiveTab] = useState("settings");
  // Custom debouncing implementation as fallback
  const [formData, setFormData] = useState(testData);
  const [debouncedFormData, setDebouncedFormData] = useState(testData);

  // Custom debounce effect
  useEffect(() => {
    const timeoutId = setTimeout(() => {
      setDebouncedFormData(formData);
    }, 500);

    return () => clearTimeout(timeoutId);
  }, [formData]);

  // Auto-save effect
  useEffect(() => {
    if (
      autoSaveEnabled &&
      (testData.name || testData.description || testData.questions.length > 0)
    ) {
      const autoSaveTimer = setTimeout(() => {
        autoSaveTest();
      }, 2000); // Auto-save after 2 seconds of inactivity

      return () => clearTimeout(autoSaveTimer);
    }
  }, [testData, autoSaveEnabled]);

  // Update test metadata when questions change
  useEffect(() => {
    const totalPoints = testData.questions.reduce(
      (sum, q) => sum + q.points,
      0
    );
    const estimatedDuration = Math.max(testData.questions.length * 2, 5); // 2 minutes per question, minimum 5 minutes

    setTestData((prev) => ({
      ...prev,
      totalPoints,
      estimatedDuration,
      updatedAt: new Date().toISOString(),
    }));
  }, [testData.questions]);

  // Preview timer effect
  useEffect(() => {
    if (previewStarted && testData.hasTimer && previewTimeRemaining > 0) {
      const timer = setInterval(() => {
        setPreviewTimeRemaining((prev) => {
          if (prev <= 1) {
            alert("Time's up! Quiz would be auto-submitted.");
            return 0;
          }
          return prev - 1;
        });
      }, 1000);

      return () => clearInterval(timer);
    }
  }, [previewStarted, testData.hasTimer, previewTimeRemaining]);

  // Debounced form logging effect
  useEffect(() => {
    if (
      debouncedFormData &&
      (debouncedFormData.name ||
        debouncedFormData.description ||
        debouncedFormData.questions.length > 0)
    ) {
      logFormData(debouncedFormData);
    }
  }, [debouncedFormData]);

  const logFormData = (data: TestData) => {
    console.group("ðŸ“ Form Data Update (Debounced)");
    console.log("ðŸ•’ Timestamp:", new Date().toISOString());

    // Basic Information
    console.log("ðŸ“‹ Basic Info:", {
      name: data.name || "(empty)",
      description: data.description || "(empty)",
      isPublic: data.isPublic,
      version: data.version,
      lastUpdated: data.updatedAt,
    });

    // Quiz Settings
    console.log("âš™ï¸ Quiz Settings:", {
      navigationMode: data.navigationMode,
      hasTimer: data.hasTimer,
      timeLimit: data.timeLimit,
      warningTime: data.warningTime,
      allowQuestionPicker: data.allowQuestionPicker,
      shuffleQuestions: data.shuffleQuestions,
      shuffleAnswers: data.shuffleAnswers,
      showProgress: data.showProgress,
      allowPause: data.allowPause,
      maxAttempts: data.maxAttempts,
      passingScore: data.passingScore,
    });

    // Questions Summary
    console.log("â“ Questions Summary:", {
      totalQuestions: data.questions.length,
      totalPoints: data.totalPoints,
      estimatedDuration: data.estimatedDuration,
      questionTypes: [...new Set(data.questions.map((q) => q.type))],
      categories: [...new Set(data.questions.map((q) => q.category))],
      difficulties: [...new Set(data.questions.map((q) => q.difficulty))],
      hasMultimedia: data.questions.some((q) => q.imageUrl || q.audioUrl),
    });

    // Performance Metrics
    console.log("ðŸ“Š Performance Metrics:", {
      formSize: JSON.stringify(data).length,
      questionsWithMedia: data.questions.filter((q) => q.imageUrl || q.audioUrl)
        .length,
      averagePointsPerQuestion:
        data.questions.length > 0
          ? (data.totalPoints / data.questions.length).toFixed(2)
          : 0,
      completionPercentage: Math.round(
        (((data.name ? 1 : 0) +
          (data.description ? 1 : 0) +
          (data.questions.length > 0 ? 1 : 0)) /
          3) *
          100
      ),
    });

    console.groupEnd();
  };

  const autoSaveTest = async () => {
    if (!testData.name.trim()) return; // Don't auto-save without a name

    setIsSaving(true);
    try {
      // Simulate API call delay
      await new Promise((resolve) => setTimeout(resolve, 500));

      const savedData = await saveTestData(testData, false);
      setLastSaved(new Date());

      console.log("ðŸ”„ Auto-saved test:", savedData.metadata);
    } catch (error) {
      console.error("Auto-save failed:", error);
    } finally {
      setIsSaving(false);
    }
  };

  const saveTestData = async (
    data: TestData,
    isManualSave = true
  ): Promise<{
    success: boolean;
    testId: string;
    metadata: SavedTestMetadata;
  }> => {
    // Generate comprehensive test metadata
    const categories = [...new Set(data.questions.map((q) => q.category))];
    const difficulties = [...new Set(data.questions.map((q) => q.difficulty))];
    const questionTypes = [...new Set(data.questions.map((q) => q.type))];
    const hasMultimedia = data.questions.some((q) => q.imageUrl || q.audioUrl);

    const metadata: SavedTestMetadata = {
      testId: data.id,
      questionCount: data.questions.length,
      totalPoints: data.totalPoints,
      categories,
      difficulties,
      questionTypes,
      hasMultimedia,
      estimatedDuration: data.estimatedDuration,
      lastSaved: new Date().toISOString(),
    };

    // Comprehensive test data for logging
    const completeTestData = {
      ...data,
      metadata,
      saveType: isManualSave ? "manual" : "auto",
      timestamp: new Date().toISOString(),
    };

    // Log detailed test data to console
    console.group(`ðŸ’¾ ${isManualSave ? "Manual" : "Auto"} Save - Test Data`);
    console.log("ðŸ“‹ Test Overview:", {
      id: data.id,
      name: data.name,
      description: data.description,
      questionCount: data.questions.length,
      totalPoints: data.totalPoints,
      estimatedDuration: `${data.estimatedDuration} minutes`,
      isPublic: data.isPublic,
      version: data.version,
    });

    console.log("âš™ï¸ Quiz Settings:", {
      navigationMode: data.navigationMode,
      hasTimer: data.hasTimer,
      timeLimit: data.timeLimit,
      warningTime: data.warningTime,
      allowQuestionPicker: data.allowQuestionPicker,
      shuffleQuestions: data.shuffleQuestions,
      shuffleAnswers: data.shuffleAnswers,
      showProgress: data.showProgress,
      allowPause: data.allowPause,
      maxAttempts: data.maxAttempts,
      passingScore: data.passingScore,
    });

    console.log("ðŸ“Š Test Statistics:", metadata);

    console.log("â“ Questions Details:");
    data.questions.forEach((question, index) => {
      console.group(`Question ${index + 1}: ${question.type}`);
      console.log("Text:", question.text);
      console.log("Category:", question.category);
      console.log("Difficulty:", question.difficulty);
      console.log("Points:", question.points);

      if (question.options) {
        console.log(
          "Options:",
          question.options.map((opt, i) => ({
            index: i + 1,
            text: opt.text,
            isCorrect: opt.isCorrect,
          }))
        );
      }

      if (question.pronunciationText) {
        console.log("Pronunciation Text:", question.pronunciationText);
      }

      if (question.fillInBlanks) {
        console.log("Fill-in-the-blank:", question.fillInBlanks);
      }

      if (question.trueFalseAnswer !== undefined) {
        console.log("True/False Answer:", question.trueFalseAnswer);
      }

      if (question.imageUrl) {
        console.log("Has Image:", true);
      }

      if (question.audioUrl) {
        console.log("Has Audio:", true);
      }

      if (question.maxListeningTime) {
        console.log(
          "Max Listening Time:",
          `${question.maxListeningTime} seconds`
        );
      }

      console.log("Created:", question.createdAt);
      console.log("Updated:", question.updatedAt);
      console.groupEnd();
    });

    console.log("ðŸ”§ Technical Details:", {
      createdAt: data.createdAt,
      updatedAt: data.updatedAt,
      authorId: data.authorId,
      version: data.version,
      tags: data.tags,
    });

    console.log("ðŸ’¾ Complete Test Data:", completeTestData);
    console.groupEnd();

    // Simulate API response
    return {
      success: true,
      testId: data.id,
      metadata,
    };
  };

  const resetModal = () => {
    setCurrentQuestion({
      type: "multiple-choice",
      text: "",
      options: [
        { text: "", isCorrect: false },
        { text: "", isCorrect: false },
      ],
      points: 1,
      difficulty: "beginner",
      category: "General",
    });
    setEditingQuestion(null);
    setErrors({});
    setUploadedFiles({});
  };

  const resetPreview = () => {
    setPreviewStarted(false);
    setPreviewCurrentQuestion(0);
    setPreviewProgress(0);
    setPreviewSelectedAnswer("");
    setPreviewAnswers({});
    setPreviewTimeRemaining(testData.hasTimer ? testData.timeLimit * 60 : 0);
  };

  const openAddModal = () => {
    resetModal();
    setIsModalOpen(true);
  };

  const openEditModal = (question: Question) => {
    setEditingQuestion(question);
    setCurrentQuestion({ ...question });
    setIsModalOpen(true);
  };

  const closeModal = () => {
    setIsModalOpen(false);
    resetModal();
  };

  const openPreview = () => {
    resetPreview();
    setIsPreviewOpen(true);
  };

  const closePreview = () => {
    setIsPreviewOpen(false);
    resetPreview();
  };

  const startPreview = () => {
    setPreviewStarted(true);
    setPreviewProgress(0);
    if (testData.hasTimer) {
      setPreviewTimeRemaining(testData.timeLimit * 60);
    }
  };

  const handleFileUpload = (type: "image" | "audio") => {
    const input =
      type === "image" ? fileInputRef.current : audioInputRef.current;
    if (input) {
      input.click();
    }
  };

  const handleFileChange = (
    event: React.ChangeEvent<HTMLInputElement>,
    type: "image" | "audio"
  ) => {
    const file = event.target.files?.[0];
    if (file) {
      setUploadedFiles((prev) => ({ ...prev, [type]: file }));

      // Create blob URL for image preview
      if (type === "image") {
        const imageUrl = URL.createObjectURL(file);
        setCurrentQuestion((prev) => ({ ...prev, imageUrl }));
      } else {
        setCurrentQuestion((prev) => ({
          ...prev,
          audioUrl: `uploaded-audio-${file.name}`,
        }));
      }

      // Log file upload
      console.log(`ðŸ“Ž File uploaded:`, {
        type,
        fileName: file.name,
        fileSize: `${(file.size / 1024).toFixed(2)} KB`,
        fileType: file.type,
        lastModified: new Date(file.lastModified).toISOString(),
      });
    }
  };

  const moveQuestion = (index: number, direction: "up" | "down") => {
    const newQuestions = [...testData.questions];
    const targetIndex = direction === "up" ? index - 1 : index + 1;

    if (targetIndex >= 0 && targetIndex < newQuestions.length) {
      [newQuestions[index], newQuestions[targetIndex]] = [
        newQuestions[targetIndex],
        newQuestions[index],
      ];
      setTestData((prev) => ({ ...prev, questions: newQuestions }));

      console.log(`ðŸ”„ Question moved ${direction}:`, {
        from: index + 1,
        to: targetIndex + 1,
        questionText: newQuestions[targetIndex].text.substring(0, 50) + "...",
      });
    }
  };

  const addFromLibrary = (libraryQuestion: Question) => {
    const newQuestion: Question = {
      ...libraryQuestion,
      id: `q_${Date.now()}`,
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString(),
    };
    setTestData((prev) => ({
      ...prev,
      questions: [...prev.questions, newQuestion],
    }));
    setIsLibraryOpen(false);

    console.log("ðŸ“š Question added from library:", {
      questionId: newQuestion.id,
      type: newQuestion.type,
      text: newQuestion.text,
      category: newQuestion.category,
      difficulty: newQuestion.difficulty,
      points: newQuestion.points,
    });
  };

  const addOption = () => {
    if (currentQuestion.options) {
      setCurrentQuestion({
        ...currentQuestion,
        options: [...currentQuestion.options, { text: "", isCorrect: false }],
      });
    }
  };

  const updateOption = (index: number, text: string) => {
    if (currentQuestion.options) {
      const newOptions = [...currentQuestion.options];
      newOptions[index].text = text;
      setCurrentQuestion({
        ...currentQuestion,
        options: newOptions,
      });
    }
  };

  const setCorrectAnswer = (index: number) => {
    if (currentQuestion.options) {
      const newOptions = currentQuestion.options.map((option, i) => ({
        ...option,
        isCorrect: i === index,
      }));
      setCurrentQuestion({
        ...currentQuestion,
        options: newOptions,
      });
    }
  };

  const removeOption = (index: number) => {
    if (currentQuestion.options && currentQuestion.options.length > 2) {
      const newOptions = currentQuestion.options.filter((_, i) => i !== index);
      setCurrentQuestion({
        ...currentQuestion,
        options: newOptions,
      });
    }
  };

  const validateQuestion = (): boolean => {
    const newErrors: Record<string, string> = {};

    if (!currentQuestion.text?.trim()) {
      newErrors.text = "Question text is required";
    }

    if (currentQuestion.type === "multiple-choice") {
      if (!currentQuestion.options || currentQuestion.options.length < 2) {
        newErrors.options = "At least 2 options are required";
      } else {
        const hasCorrectAnswer = currentQuestion.options.some(
          (option) => option.isCorrect
        );
        if (!hasCorrectAnswer) {
          newErrors.correct = "Please select a correct answer";
        }
        const emptyOptions = currentQuestion.options.some(
          (option) => !option.text.trim()
        );
        if (emptyOptions) {
          newErrors.optionText = "All options must have text";
        }
      }
    }

    if (currentQuestion.type === "pronunciation") {
      if (!currentQuestion.pronunciationText?.trim()) {
        newErrors.pronunciationText = "Text to pronounce is required";
      }
    }

    if (currentQuestion.type === "fill-in-the-blank") {
      if (!currentQuestion.fillInBlanks?.text?.trim()) {
        newErrors.fillInBlanks = "Fill-in-the-blank text is required";
      } else if (!currentQuestion.fillInBlanks.text.includes("_____")) {
        newErrors.fillInBlanks =
          "Text must contain at least one blank marked with _____";
      } else {
        const blankCount =
          currentQuestion.fillInBlanks.text.split("_____").length - 1;
        const answeredBlanks =
          currentQuestion.fillInBlanks.blanks?.filter((blank) =>
            blank.answer.trim()
          ).length || 0;
        if (answeredBlanks < blankCount) {
          newErrors.fillInBlanksAnswers = `Please provide answers for all ${blankCount} blanks`;
        }
      }
    }

    if (currentQuestion.type === "true-false") {
      if (currentQuestion.trueFalseAnswer === undefined) {
        newErrors.trueFalse = "Please select the correct answer";
      }
    }

    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  };

  const saveQuestion = () => {
    if (!validateQuestion()) return;

    const now = new Date().toISOString();
    const questionToSave: Question = {
      id: editingQuestion?.id || `q_${Date.now()}`,
      type: currentQuestion.type!,
      text: currentQuestion.text!,
      points: currentQuestion.points || 1,
      difficulty: currentQuestion.difficulty || "beginner",
      category: currentQuestion.category || "General",
      createdAt: editingQuestion?.createdAt || now,
      updatedAt: now,
      ...(currentQuestion.type === "multiple-choice" && {
        options: currentQuestion.options,
      }),
      ...(currentQuestion.type === "pronunciation" && {
        pronunciationText: currentQuestion.pronunciationText,
      }),
      ...(currentQuestion.type === "fill-in-the-blank" && {
        fillInBlanks: currentQuestion.fillInBlanks,
      }),
      ...(currentQuestion.type === "true-false" && {
        trueFalseAnswer: currentQuestion.trueFalseAnswer,
      }),
      ...(currentQuestion.type === "listening" && {
        audioUrl: currentQuestion.audioUrl,
        maxListeningTime: currentQuestion.maxListeningTime,
      }),
      ...(currentQuestion.imageUrl && { imageUrl: currentQuestion.imageUrl }),
      ...(currentQuestion.audioUrl &&
        currentQuestion.type !== "listening" && {
          audioUrl: currentQuestion.audioUrl,
        }),
    };

    let updatedTestData: TestData;
    if (editingQuestion) {
      updatedTestData = {
        ...testData,
        questions: testData.questions.map((q) =>
          q.id === editingQuestion.id ? questionToSave : q
        ),
      };
      console.log("âœï¸ Question updated:", {
        questionId: questionToSave.id,
        type: questionToSave.type,
        text: questionToSave.text,
        changes: "Question modified",
      });
    } else {
      updatedTestData = {
        ...testData,
        questions: [...testData.questions, questionToSave],
      };
      console.log("âž• New question added:", {
        questionId: questionToSave.id,
        type: questionToSave.type,
        text: questionToSave.text,
        category: questionToSave.category,
        difficulty: questionToSave.difficulty,
        points: questionToSave.points,
      });
    }

    setTestData(updatedTestData);
    setFormData(updatedTestData);
    closeModal();
  };

  const deleteQuestion = (id: string) => {
    const questionToDelete = testData.questions.find((q) => q.id === id);
    const updatedTestData = {
      ...testData,
      questions: testData.questions.filter((q) => q.id !== id),
    };

    setTestData(updatedTestData);
    setFormData(updatedTestData);

    console.log("ðŸ—‘ï¸ Question deleted:", {
      questionId: id,
      text: questionToDelete?.text,
      type: questionToDelete?.type,
      deletedAt: new Date().toISOString(),
    });
  };

  const saveTest = async () => {
    if (!testData.name.trim()) {
      toast({
        title: "Error",
        description: "Please enter a test name before saving.",
        variant: "destructive",
      });
      return;
    }

    if (testData.questions.length === 0) {
      toast({
        title: "Error",
        description: "Please add at least one question before saving.",
        variant: "destructive",
      });
      return;
    }

    setIsSaving(true);
    try {
      const result = await saveTestData(testData, true);
      setLastSaved(new Date());

      toast({
        title: "Success",
        description: `Test "${testData.name}" saved successfully!`,
      });

      console.log("âœ… Test saved successfully:", result);
    } catch (error) {
      console.error("âŒ Save failed:", error);
      toast({
        title: "Error",
        description: "Failed to save test. Please try again.",
        variant: "destructive",
      });
    } finally {
      setIsSaving(false);
    }
  };

  const handleTestInfoChange = (
    field: keyof TestData,
    value: string | boolean | number
  ) => {
    const updatedData = {
      ...testData,
      [field]: value,
      updatedAt: new Date().toISOString(),
    };

    setTestData(updatedData);
    setFormData(updatedData);

    console.log(`ðŸ“ Field "${field}" updated:`, {
      field,
      value,
      timestamp: new Date().toISOString(),
    });
  };

  const getDifficultyColor = (difficulty: string) => {
    switch (difficulty) {
      case "beginner":
        return "bg-green-100 text-green-800";
      case "intermediate":
        return "bg-yellow-100 text-yellow-800";
      case "advanced":
        return "bg-red-100 text-red-800";
      default:
        return "bg-gray-100 text-gray-800";
    }
  };

  const getQuestionTypeIcon = (type: string) => {
    switch (type) {
      case "multiple-choice":
        return "MC";
      case "pronunciation":
        return "ðŸŽ¤";
      case "fill-in-the-blank":
        return "___";
      case "true-false":
        return "T/F";
      case "listening":
        return "ðŸŽ§";
      default:
        return "?";
    }
  };

  const formatTime = (seconds: number) => {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins}:${secs.toString().padStart(2, "0")}`;
  };

  const renderQuestionForm = () => {
    return (
      <div className="space-y-6">
        {/* Question Type and Settings */}
        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <Label className="text-gray-700">Question Type</Label>
            <Select
              value={currentQuestion.type}
              onValueChange={(value: Question["type"]) => {
                setCurrentQuestion({
                  ...currentQuestion,
                  type: value,
                  ...(value === "multiple-choice" && {
                    options: [
                      { text: "", isCorrect: false },
                      { text: "", isCorrect: false },
                    ],
                  }),
                  ...(value === "fill-in-the-blank" && {
                    fillInBlanks: { text: "", blanks: [] },
                  }),
                });
                setErrors({});
              }}
            >
              <SelectTrigger className="focus:border-teal-500 focus:ring-teal-500">
                <SelectValue />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="multiple-choice">Multiple Choice</SelectItem>
                <SelectItem value="pronunciation">Pronunciation</SelectItem>
                <SelectItem value="fill-in-the-blank">
                  Fill in the Blank
                </SelectItem>
                <SelectItem value="true-false">True/False</SelectItem>
                <SelectItem value="listening">Listening</SelectItem>
              </SelectContent>
            </Select>
          </div>

          <div>
            <Label className="text-gray-700">Points</Label>
            <Input
              type="number"
              min="1"
              max="10"
              value={currentQuestion.points}
              onChange={(e) =>
                setCurrentQuestion({
                  ...currentQuestion,
                  points: Number(e.target.value),
                })
              }
              className="focus:border-teal-500 focus:ring-teal-500"
            />
          </div>

          <div>
            <Label className="text-gray-700">Difficulty</Label>
            <Select
              value={currentQuestion.difficulty}
              onValueChange={(value: Question["difficulty"]) =>
                setCurrentQuestion({ ...currentQuestion, difficulty: value })
              }
            >
              <SelectTrigger className="focus:border-teal-500 focus:ring-teal-500">
                <SelectValue />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="beginner">Beginner</SelectItem>
                <SelectItem value="intermediate">Intermediate</SelectItem>
                <SelectItem value="advanced">Advanced</SelectItem>
              </SelectContent>
            </Select>
          </div>
        </div>

        {/* Category */}
        <div>
          <Label className="text-gray-700">Category</Label>
          <Select
            value={currentQuestion.category}
            onValueChange={(value) =>
              setCurrentQuestion({ ...currentQuestion, category: value })
            }
          >
            <SelectTrigger className="focus:border-teal-500 focus:ring-teal-500">
              <SelectValue />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="Grammar">Grammar</SelectItem>
              <SelectItem value="Vocabulary">Vocabulary</SelectItem>
              <SelectItem value="Pronunciation">Pronunciation</SelectItem>
              <SelectItem value="Listening">Listening</SelectItem>
              <SelectItem value="Reading">Reading</SelectItem>
              <SelectItem value="General">General</SelectItem>
            </SelectContent>
          </Select>
        </div>

        {/* Rich Text Question */}
        <div>
          <Label className="text-gray-700">Question Text</Label>
          <Textarea
            placeholder="Enter your question here..."
            value={currentQuestion.text}
            onChange={(e) =>
              setCurrentQuestion({ ...currentQuestion, text: e.target.value })
            }
            className="focus:border-teal-500 focus:ring-teal-500 min-h-[100px]"
          />
          {errors.text && (
            <p className="text-red-500 text-sm mt-1">{errors.text}</p>
          )}
        </div>

        {/* Multimedia Upload */}
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          {/* Add Image */}
          <div>
            <Label className="text-gray-700">Add Image</Label>
            <div className="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center">
              {uploadedFiles.image ? (
                <div className="space-y-2">
                  <div className="w-full max-w-xs mx-auto">
                    <img
                      src={currentQuestion.imageUrl || "/placeholder.svg"}
                      alt="Question image preview"
                      className="w-full h-32 object-cover rounded-lg border"
                    />
                  </div>
                  <p className="text-sm text-gray-600">
                    {uploadedFiles.image.name}
                  </p>
                  <Button
                    size="sm"
                    variant="outline"
                    onClick={() => {
                      if (currentQuestion.imageUrl) {
                        URL.revokeObjectURL(currentQuestion.imageUrl);
                      }
                      setUploadedFiles((prev) => {
                        const newFiles = { ...prev };
                        delete newFiles.image;
                        return newFiles;
                      });
                      setCurrentQuestion({
                        ...currentQuestion,
                        imageUrl: undefined,
                      });
                    }}
                  >
                    Remove
                  </Button>
                </div>
              ) : (
                <Button
                  type="button"
                  variant="outline"
                  onClick={() => handleFileUpload("image")}
                  className="border-teal-500 text-teal-600 hover:bg-teal-50"
                >
                  <ImageIcon className="h-4 w-4 mr-2" />
                  Upload Image
                </Button>
              )}
            </div>
          </div>

          {/* Add Audio */}
          <div>
            <Label className="text-gray-700">Add Audio</Label>
            <div className="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center">
              {uploadedFiles.audio ? (
                <div className="space-y-2">
                  <div className="w-full p-4 bg-gray-100 rounded flex items-center justify-center">
                    <Volume2 className="h-6 w-6 text-gray-400" />
                    <span className="ml-2 text-sm text-gray-600">
                      {uploadedFiles.audio.name}
                    </span>
                  </div>
                  <Button
                    size="sm"
                    variant="outline"
                    onClick={() => {
                      setUploadedFiles((prev) => {
                        const newFiles = { ...prev };
                        delete newFiles.audio;
                        return newFiles;
                      });
                      setCurrentQuestion({
                        ...currentQuestion,
                        audioUrl: undefined,
                      });
                    }}
                  >
                    Remove
                  </Button>
                </div>
              ) : (
                <Button
                  type="button"
                  variant="outline"
                  onClick={() => handleFileUpload("audio")}
                  className="border-teal-500 text-teal-600 hover:bg-teal-50"
                >
                  <Volume2 className="h-4 w-4 mr-2" />
                  Upload Audio
                </Button>
              )}
            </div>
          </div>
        </div>

        {/* Question Type Specific Fields */}
        {currentQuestion.type === "multiple-choice" && (
          <div>
            <Label className="text-gray-700">Answer Options</Label>
            <div className="space-y-3">
              <RadioGroup
                value={currentQuestion.options
                  ?.findIndex((opt) => opt.isCorrect)
                  ?.toString()}
                onValueChange={(value) =>
                  setCorrectAnswer(Number.parseInt(value))
                }
              >
                {currentQuestion.options?.map((option, index) => (
                  <div key={index} className="flex items-center space-x-2">
                    <RadioGroupItem
                      value={index.toString()}
                      id={`option-${index}`}
                    />
                    <Input
                      placeholder="Enter an option"
                      value={option.text}
                      onChange={(e) => updateOption(index, e.target.value)}
                      className="flex-1 focus:border-teal-500 focus:ring-teal-500"
                    />
                    {currentQuestion.options &&
                      currentQuestion.options.length > 2 && (
                        <Button
                          type="button"
                          size="sm"
                          variant="outline"
                          onClick={() => removeOption(index)}
                          className="border-red-400 text-red-600 hover:bg-red-50"
                        >
                          <X className="h-4 w-4" />
                        </Button>
                      )}
                  </div>
                ))}
              </RadioGroup>
              <Button
                type="button"
                variant="outline"
                onClick={addOption}
                className="border-teal-500 text-teal-600 hover:bg-teal-50"
              >
                <Plus className="h-4 w-4 mr-2" />
                Add Option
              </Button>
            </div>
            {errors.options && (
              <p className="text-red-500 text-sm mt-1">{errors.options}</p>
            )}
            {errors.correct && (
              <p className="text-red-500 text-sm mt-1">{errors.correct}</p>
            )}
            {errors.optionText && (
              <p className="text-red-500 text-sm mt-1">{errors.optionText}</p>
            )}
          </div>
        )}

        {currentQuestion.type === "pronunciation" && (
          <div>
            <Label className="text-gray-700">Text to Pronounce</Label>
            <Textarea
              placeholder="Enter word or sentence to pronounce"
              value={currentQuestion.pronunciationText}
              onChange={(e) =>
                setCurrentQuestion({
                  ...currentQuestion,
                  pronunciationText: e.target.value,
                })
              }
              className="focus:border-teal-500 focus:ring-teal-500"
            />
            {errors.pronunciationText && (
              <p className="text-red-500 text-sm mt-1">
                {errors.pronunciationText}
              </p>
            )}
          </div>
        )}

        {currentQuestion.type === "fill-in-the-blank" && (
          <div className="space-y-4">
            <div>
              <Label className="text-gray-700">Fill-in-the-Blank Text</Label>
              <Textarea
                placeholder="Enter text with blanks marked as _____ (e.g., 'I _____ to school every day.')"
                value={currentQuestion.fillInBlanks?.text}
                onChange={(e) =>
                  setCurrentQuestion({
                    ...currentQuestion,
                    fillInBlanks: {
                      ...currentQuestion.fillInBlanks,
                      text: e.target.value,
                      blanks: [],
                    },
                  })
                }
                className="focus:border-teal-500 focus:ring-teal-500"
              />
              <p className="text-sm text-gray-500 mt-1">
                Use _____ to mark blanks in your text
              </p>
              {errors.fillInBlanks && (
                <p className="text-red-500 text-sm mt-1">
                  {errors.fillInBlanks}
                </p>
              )}
            </div>

            <div>
              <Label className="text-gray-700">Correct Answers</Label>
              <div className="space-y-2">
                {currentQuestion.fillInBlanks?.text?.split("_____").length >
                  1 && (
                  <div className="space-y-3">
                    {Array.from(
                      {
                        length:
                          (currentQuestion.fillInBlanks?.text?.split("_____")
                            .length || 1) - 1,
                      },
                      (_, index) => (
                        <div
                          key={index}
                          className="flex items-center space-x-2"
                        >
                          <Label className="text-sm text-gray-600 min-w-[80px]">
                            Blank {index + 1}:
                          </Label>
                          <Input
                            placeholder="Enter correct answer"
                            value={
                              currentQuestion.fillInBlanks?.blanks?.[index]
                                ?.answer || ""
                            }
                            onChange={(e) => {
                              const newBlanks = [
                                ...(currentQuestion.fillInBlanks?.blanks || []),
                              ];
                              newBlanks[index] = {
                                position: index,
                                answer: e.target.value,
                              };
                              setCurrentQuestion({
                                ...currentQuestion,
                                fillInBlanks: {
                                  ...currentQuestion.fillInBlanks,
                                  text:
                                    currentQuestion.fillInBlanks?.text || "",
                                  blanks: newBlanks,
                                },
                              });
                            }}
                            className="flex-1 focus:border-teal-500 focus:ring-teal-500"
                          />
                        </div>
                      )
                    )}
                  </div>
                )}
                {!currentQuestion.fillInBlanks?.text?.includes("_____") && (
                  <p className="text-sm text-amber-600">
                    Add _____ to your text to create blanks
                  </p>
                )}
              </div>
              {errors.fillInBlanksAnswers && (
                <p className="text-red-500 text-sm mt-1">
                  {errors.fillInBlanksAnswers}
                </p>
              )}
            </div>
          </div>
        )}

        {currentQuestion.type === "true-false" && (
          <div>
            <Label className="text-gray-700">Correct Answer</Label>
            <RadioGroup
              value={currentQuestion.trueFalseAnswer?.toString()}
              onValueChange={(value) =>
                setCurrentQuestion({
                  ...currentQuestion,
                  trueFalseAnswer: value === "true",
                })
              }
            >
              <div className="flex items-center space-x-2">
                <RadioGroupItem value="true" id="true" />
                <Label htmlFor="true">True</Label>
              </div>
              <div className="flex items-center space-x-2">
                <RadioGroupItem value="false" id="false" />
                <Label htmlFor="false">False</Label>
              </div>
            </RadioGroup>
            {errors.trueFalse && (
              <p className="text-red-500 text-sm mt-1">{errors.trueFalse}</p>
            )}
          </div>
        )}

        {currentQuestion.type === "listening" && (
          <div className="space-y-4">
            <div>
              <Label className="text-gray-700">
                Maximum Listening Time (seconds)
              </Label>
              <div className="space-y-2">
                <Slider
                  value={[currentQuestion.maxListeningTime || 30]}
                  onValueChange={(value) =>
                    setCurrentQuestion({
                      ...currentQuestion,
                      maxListeningTime: value[0],
                    })
                  }
                  max={180}
                  min={10}
                  step={5}
                  className="w-full"
                />
                <div className="text-sm text-gray-500 text-center">
                  {currentQuestion.maxListeningTime || 30} seconds
                </div>
              </div>
            </div>
            <div>
              <Label className="text-gray-700">Answer Options</Label>
              <div className="space-y-3">
                <RadioGroup
                  value={currentQuestion.options
                    ?.findIndex((opt) => opt.isCorrect)
                    ?.toString()}
                  onValueChange={(value) =>
                    setCorrectAnswer(Number.parseInt(value))
                  }
                >
                  {currentQuestion.options?.map((option, index) => (
                    <div key={index} className="flex items-center space-x-2">
                      <RadioGroupItem
                        value={index.toString()}
                        id={`listening-option-${index}`}
                      />
                      <Input
                        placeholder="Enter an option"
                        value={option.text}
                        onChange={(e) => updateOption(index, e.target.value)}
                        className="flex-1 focus:border-teal-500 focus:ring-teal-500"
                      />
                      {currentQuestion.options &&
                        currentQuestion.options.length > 2 && (
                          <Button
                            type="button"
                            size="sm"
                            variant="outline"
                            onClick={() => removeOption(index)}
                            className="border-red-400 text-red-600 hover:bg-red-50"
                          >
                            <X className="h-4 w-4" />
                          </Button>
                        )}
                    </div>
                  ))}
                </RadioGroup>
                <Button
                  type="button"
                  variant="outline"
                  onClick={addOption}
                  className="border-teal-500 text-teal-600 hover:bg-teal-50"
                >
                  <Plus className="h-4 w-4 mr-2" />
                  Add Option
                </Button>
              </div>
            </div>
          </div>
        )}

        {/* Hidden file inputs */}
        <input
          ref={fileInputRef}
          type="file"
          accept="image/*"
          onChange={(e) => handleFileChange(e, "image")}
          className="hidden"
        />
        <input
          ref={audioInputRef}
          type="file"
          accept="audio/*"
          onChange={(e) => handleFileChange(e, "audio")}
          className="hidden"
        />
      </div>
    );
  };

  const renderPreviewContent = () => {
    // Check if we have questions before proceeding
    if (!testData.questions || testData.questions.length === 0) {
      return (
        <div className="max-w-4xl mx-auto">
          <Card className="border-yellow-100">
            <CardContent className="text-center py-8">
              <p className="text-yellow-600">
                No questions available for preview
              </p>
              <Button onClick={closePreview} className="mt-4">
                Close Preview
              </Button>
            </CardContent>
          </Card>
        </div>
      );
    }

    // Ensure previewCurrentQuestion is within bounds
    if (previewCurrentQuestion >= testData.questions.length) {
      setPreviewCurrentQuestion(0);
      return null;
    }

    if (!previewStarted) {
      return (
        <div className="max-w-4xl mx-auto">
          <Card className="border-teal-100">
            <CardHeader className="text-center">
              <div className="flex items-center justify-center mb-4">
                <div className="w-16 h-16 bg-teal-100 rounded-full flex items-center justify-center">
                  <Eye className="h-8 w-8 text-teal-600" />
                </div>
              </div>
              <CardTitle className="text-3xl font-bold mb-4">
                {testData.name || "Untitled Test"}
              </CardTitle>
              <div className="text-lg mb-6 text-gray-600">
                {testData.description || "No description provided"}
              </div>

              <div className="flex items-center justify-center space-x-8 text-sm text-gray-600 mb-8">
                <div className="flex items-center">
                  <span className="font-medium">
                    {testData.questions.length} Questions
                  </span>
                </div>
                <div className="flex items-center">
                  <span>{testData.totalPoints} Total Points</span>
                </div>
                <div className="flex items-center">
                  <span>~{testData.estimatedDuration} minutes</span>
                </div>
                {testData.hasTimer && (
                  <div className="flex items-center">
                    <Timer className="h-4 w-4 mr-1" />
                    <span>{testData.timeLimit} min limit</span>
                  </div>
                )}
              </div>
            </CardHeader>
            <CardContent className="text-center space-y-6">
              <div className="bg-teal-50 p-6 rounded-lg">
                <h3 className="font-semibold text-lg mb-2">
                  Quiz Settings Preview:
                </h3>
                <div className="text-left space-y-2 max-w-md mx-auto text-sm">
                  <div className="flex justify-between">
                    <span>Navigation:</span>
                    <span className="font-medium">
                      {testData.navigationMode === "sequential"
                        ? "Sequential"
                        : testData.navigationMode === "back-only"
                        ? "Back Only"
                        : "Free Navigation"}
                    </span>
                  </div>
                  <div className="flex justify-between">
                    <span>Timer:</span>
                    <span className="font-medium">
                      {testData.hasTimer
                        ? `${testData.timeLimit} minutes`
                        : "No limit"}
                    </span>
                  </div>
                  <div className="flex justify-between">
                    <span>Question Picker:</span>
                    <span className="font-medium">
                      {testData.allowQuestionPicker ? "Enabled" : "Disabled"}
                    </span>
                  </div>
                  <div className="flex justify-between">
                    <span>Shuffle Questions:</span>
                    <span className="font-medium">
                      {testData.shuffleQuestions ? "Yes" : "No"}
                    </span>
                  </div>
                  <div className="flex justify-between">
                    <span>Max Attempts:</span>
                    <span className="font-medium">{testData.maxAttempts}</span>
                  </div>
                  <div className="flex justify-between">
                    <span>Passing Score:</span>
                    <span className="font-medium">
                      {testData.passingScore}%
                    </span>
                  </div>
                </div>
              </div>

              <div className="flex gap-4 justify-center">
                <Button
                  size="lg"
                  onClick={startPreview}
                  className="bg-teal-600 hover:bg-teal-700 text-white px-8 py-4 text-lg transform hover:scale-105 transition-all duration-200"
                >
                  <Play className="h-5 w-5 mr-2" />
                  Start Preview
                </Button>
                <Button
                  size="lg"
                  variant="outline"
                  onClick={closePreview}
                  className="border-gray-600 text-gray-600 hover:bg-gray-50 px-8 py-4 text-lg"
                >
                  Close Preview
                </Button>
              </div>
            </CardContent>
          </Card>
        </div>
      );
    }

    const currentQ = testData.questions[previewCurrentQuestion];

    if (!currentQ) {
      return (
        <div className="max-w-4xl mx-auto">
          <Card className="border-red-100">
            <CardContent className="text-center py-8">
              <p className="text-red-600">Error: Question not found</p>
              <Button onClick={closePreview} className="mt-4">
                Close Preview
              </Button>
            </CardContent>
          </Card>
        </div>
      );
    }

    return (
      <div className="max-w-4xl mx-auto">
        {/* Progress Header */}
        <div className="mb-8">
          <div className="flex items-center justify-between mb-4">
            <h1 className="text-2xl font-bold text-gray-900">
              {testData.name || "Untitled Test"}
            </h1>
            <div className="flex items-center space-x-4">
              {testData.hasTimer && (
                <div
                  className={`flex items-center space-x-2 px-3 py-1 rounded-lg ${
                    previewTimeRemaining < 300
                      ? "bg-red-100 text-red-700"
                      : "bg-blue-100 text-blue-700"
                  }`}
                >
                  <Timer className="h-4 w-4" />
                  <span className="font-mono font-semibold">
                    {formatTime(previewTimeRemaining)}
                  </span>
                </div>
              )}
              <span className="text-sm text-gray-600">
                Question {previewCurrentQuestion + 1} of{" "}
                {testData.questions.length}
              </span>
              <Button
                variant="outline"
                size="sm"
                onClick={closePreview}
                className="border-gray-400 text-gray-600 hover:bg-gray-50"
              >
                Exit Preview
              </Button>
            </div>
          </div>
          <Progress value={previewProgress} className="h-2 bg-teal-100" />
        </div>

        {/* Question Card */}
        <Card className="border-teal-100 mb-8">
          <CardHeader>
            <div className="flex items-center justify-between">
              <CardTitle className="text-xl">{currentQ.text}</CardTitle>
              <div className="flex items-center space-x-2">
                <Badge className={getDifficultyColor(currentQ.difficulty)}>
                  {currentQ.difficulty}
                </Badge>
                <Badge variant="outline">{currentQ.points} pts</Badge>
              </div>
            </div>
            <div className="text-sm text-gray-500">
              {currentQ.category} â€¢ {currentQ.type.replace("-", " ")}
            </div>
          </CardHeader>
          <CardContent>
            {currentQ.imageUrl && (
              <div className="mb-4">
                <img
                  src={currentQ.imageUrl || "/placeholder.svg"}
                  alt="Question image"
                  className="max-w-full h-auto rounded-lg border shadow-sm"
                />
              </div>
            )}

            {currentQ.audioUrl && (
              <div className="mb-4">
                <div className="flex items-center text-sm text-gray-600">
                  <Volume2 className="h-4 w-4 mr-1" />
                  Audio file attached
                </div>
              </div>
            )}

            {/* Question type specific rendering */}
            {currentQ.type === "multiple-choice" && currentQ.options && (
              <RadioGroup
                value={previewSelectedAnswer}
                onValueChange={setPreviewSelectedAnswer}
              >
                <div className="space-y-4">
                  {currentQ.options.map((option, index) => (
                    <div key={index} className="flex items-center space-x-3">
                      <RadioGroupItem
                        value={option.text}
                        id={`preview-option-${index}`}
                      />
                      <Label
                        htmlFor={`preview-option-${index}`}
                        className="flex-1 p-4 border border-gray-200 rounded-lg cursor-pointer hover:bg-teal-50 transition-colors"
                      >
                        {option.text}
                      </Label>
                    </div>
                  ))}
                </div>
              </RadioGroup>
            )}

            {currentQ.type === "fill-in-the-blank" && currentQ.fillInBlanks && (
              <div className="space-y-4">
                <div className="p-4 border border-gray-200 rounded-lg bg-gray-50">
                  <p className="text-gray-700">
                    {currentQ.fillInBlanks.text
                      .split("_____")
                      .map((part, index, array) => (
                        <span key={index}>
                          {part}
                          {index < array.length - 1 && (
                            <input
                              type="text"
                              className="mx-2 px-2 py-1 border border-gray-300 rounded w-24 text-center"
                              placeholder="___"
                            />
                          )}
                        </span>
                      ))}
                  </p>
                </div>
                <div className="text-sm text-gray-500">
                  Fill in the blanks with the appropriate words
                </div>
              </div>
            )}

            {currentQ.type === "true-false" && (
              <RadioGroup
                value={previewSelectedAnswer}
                onValueChange={setPreviewSelectedAnswer}
              >
                <div className="space-y-4">
                  <div className="flex items-center space-x-3">
                    <RadioGroupItem value="true" id="preview-true" />
                    <Label
                      htmlFor="preview-true"
                      className="flex-1 p-4 border border-gray-200 rounded-lg cursor-pointer hover:bg-teal-50 transition-colors"
                    >
                      True
                    </Label>
                  </div>
                  <div className="flex items-center space-x-3">
                    <RadioGroupItem value="false" id="preview-false" />
                    <Label
                      htmlFor="preview-false"
                      className="flex-1 p-4 border border-gray-200 rounded-lg cursor-pointer hover:bg-teal-50 transition-colors"
                    >
                      False
                    </Label>
                  </div>
                </div>
              </RadioGroup>
            )}

            {currentQ.type === "pronunciation" && (
              <div className="space-y-4">
                <div className="p-4 border border-gray-200 rounded-lg bg-blue-50">
                  <p className="text-lg font-medium text-center text-blue-800">
                    "{currentQ.pronunciationText}"
                  </p>
                </div>
                <div className="text-center">
                  <Button className="bg-red-500 hover:bg-red-600 text-white">
                    ðŸŽ¤ Start Recording
                  </Button>
                </div>
                <div className="text-sm text-gray-500 text-center">
                  Click the microphone to record your pronunciation
                </div>
              </div>
            )}
          </CardContent>
        </Card>

        {/* Navigation */}
        <div className="flex justify-between">
          <Button
            variant="outline"
            onClick={() => {
              if (previewCurrentQuestion > 0 && testData.questions.length > 0) {
                const newIndex = previewCurrentQuestion - 1;
                setPreviewCurrentQuestion(newIndex);
                setPreviewProgress(
                  (newIndex / testData.questions.length) * 100
                );
              }
            }}
            disabled={previewCurrentQuestion === 0}
            className="border-teal-600 text-teal-600 hover:bg-teal-50 disabled:opacity-50"
          >
            <ArrowLeft className="h-4 w-4 mr-2" />
            Previous
          </Button>

          <div className="flex space-x-2">
            <Button
              variant="outline"
              onClick={() => setPreviewStarted(false)}
              className="border-gray-400 text-gray-600 hover:bg-gray-50"
            >
              <RotateCcw className="h-4 w-4 mr-2" />
              Restart Preview
            </Button>

            {previewCurrentQuestion < testData.questions.length - 1 ? (
              <Button
                onClick={() => {
                  if (previewCurrentQuestion < testData.questions.length - 1) {
                    const newIndex = previewCurrentQuestion + 1;
                    setPreviewCurrentQuestion(newIndex);
                    setPreviewProgress(
                      (newIndex / testData.questions.length) * 100
                    );
                  }
                }}
                className="bg-teal-600 hover:bg-teal-700 text-white"
              >
                Next Question
                <ArrowRight className="h-4 w-4 ml-2" />
              </Button>
            ) : (
              <Button
                onClick={() => alert("Preview completed!")}
                className="bg-teal-600 hover:bg-teal-700 text-white"
              >
                Finish Preview
              </Button>
            )}
          </div>
        </div>
      </div>
    );
  };

  return (
    <div className="container mx-auto px-4 py-8 max-w-6xl animate-fade-in">
      {/* Header */}
      <div className="text-center mb-8">
        <h1 className="text-3xl font-bold text-gray-800">Create Quiz</h1>
        {/* Auto-save indicator */}
        <div className="flex items-center justify-center mt-2 space-x-4">
          {isSaving && (
            <div className="flex items-center text-sm text-gray-500">
              <Clock className="h-4 w-4 mr-1 animate-spin" />
              Saving...
            </div>
          )}
          {lastSaved && !isSaving && (
            <div className="flex items-center text-sm text-green-600">
              <CheckCircle className="h-4 w-4 mr-1" />
              Last saved: {lastSaved.toLocaleTimeString()}
            </div>
          )}
        </div>
      </div>

      <Tabs value={activeTab} onValueChange={setActiveTab} className="w-full">
        <TabsList className="grid w-full grid-cols-2 mb-8">
          <TabsTrigger value="settings" className="flex items-center space-x-2">
            <Settings className="h-4 w-4" />
            <span>Test Settings</span>
          </TabsTrigger>
          <TabsTrigger
            value="questions"
            className="flex items-center space-x-2"
          >
            <FileText className="h-4 w-4" />
            <span>Questions ({testData.questions.length})</span>
          </TabsTrigger>
        </TabsList>

        <TabsContent value="settings" className="space-y-0">
          <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
            {/* Main Content - Settings */}
            <div className="lg:col-span-2 space-y-8">
              {/* Test Information Section */}
              <Card className="border-gray-200">
                <CardHeader>
                  <CardTitle className="text-xl text-gray-800">
                    Test Information
                  </CardTitle>
                </CardHeader>
                <CardContent className="space-y-4">
                  <div>
                    <Label htmlFor="testName" className="text-gray-700">
                      Test Name
                    </Label>
                    <Input
                      id="testName"
                      placeholder="Enter test name"
                      value={testData.name}
                      onChange={(e) =>
                        handleTestInfoChange("name", e.target.value)
                      }
                      className="w-full p-2 border rounded focus:border-teal-500 focus:ring-teal-500"
                    />
                  </div>
                  <div>
                    <Label htmlFor="testDescription" className="text-gray-700">
                      Test Description
                    </Label>
                    <Textarea
                      id="testDescription"
                      placeholder="Enter test description (optional)"
                      value={testData.description}
                      onChange={(e) =>
                        handleTestInfoChange("description", e.target.value)
                      }
                      className="w-full p-2 border rounded focus:border-teal-500 focus:ring-teal-500 min-h-[80px]"
                    />
                  </div>
                </CardContent>
              </Card>

              {/* Enhanced Quiz Settings Section */}
              <Card className="border-gray-200">
                <CardHeader>
                  <CardTitle className="text-xl text-gray-800 flex items-center">
                    <Settings className="h-5 w-5 mr-2" />
                    Quiz Settings
                  </CardTitle>
                  <p className="text-sm text-gray-500">
                    Configure how students will take this quiz
                  </p>
                </CardHeader>
                <CardContent className="space-y-6">
                  {/* Navigation Mode */}
                  <div>
                    <Label className="text-gray-700 font-medium">
                      Navigation Mode
                    </Label>
                    <Select
                      value={testData.navigationMode}
                      onValueChange={(value: TestData["navigationMode"]) =>
                        handleTestInfoChange("navigationMode", value)
                      }
                    >
                      <SelectTrigger className="focus:border-teal-500 focus:ring-teal-500">
                        <SelectValue />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="sequential">
                          Sequential Only (Must answer in order, no going back)
                        </SelectItem>
                        <SelectItem value="back-only">
                          Back Only (Can review previous questions, no skipping
                          ahead)
                        </SelectItem>
                        <SelectItem value="free-navigation">
                          Free Navigation (Jump to any question freely)
                        </SelectItem>
                      </SelectContent>
                    </Select>
                    <p className="text-sm text-gray-500 mt-1">
                      {testData.navigationMode === "sequential" &&
                        "Students must answer questions in order and cannot go back"}
                      {testData.navigationMode === "back-only" &&
                        "Students can review previous questions but cannot skip ahead"}
                      {testData.navigationMode === "free-navigation" &&
                        "Students can navigate freely between all questions"}
                    </p>
                  </div>

                  {/* Timer Settings */}
                  <div className="space-y-4">
                    <div className="flex items-center justify-between">
                      <div className="space-y-0.5">
                        <Label
                          htmlFor="hasTimer"
                          className="text-gray-700 font-medium"
                        >
                          Enable Timer
                        </Label>
                        <p className="text-sm text-gray-500">
                          Set a time limit for the entire quiz
                        </p>
                      </div>
                      <Switch
                        id="hasTimer"
                        checked={testData.hasTimer}
                        onCheckedChange={(checked) =>
                          handleTestInfoChange("hasTimer", checked)
                        }
                      />
                    </div>

                    {testData.hasTimer && (
                      <div className="space-y-4 pl-4 border-l-2 border-teal-200">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                          <div>
                            <Label className="text-gray-700">
                              Time Limit (minutes)
                            </Label>
                            <Input
                              type="number"
                              min="5"
                              max="300"
                              value={testData.timeLimit}
                              onChange={(e) =>
                                handleTestInfoChange(
                                  "timeLimit",
                                  Number(e.target.value)
                                )
                              }
                              className="focus:border-teal-500 focus:ring-teal-500"
                            />
                            <p className="text-sm text-gray-500 mt-1">
                              Students will have {testData.timeLimit} minutes to
                              complete the quiz
                            </p>
                          </div>
                          <div>
                            <Label className="text-gray-700">
                              Warning Time (minutes before end
                            </Label>
                            <Input
                              type="number"
                              min="1"
                              max={Math.floor(testData.timeLimit / 2)}
                              value={testData.warningTime}
                              onChange={(e) =>
                                handleTestInfoChange(
                                  "warningTime",
                                  Number(e.target.value)
                                )
                              }
                              className="focus:border-teal-500 focus:ring-teal-500"
                            />
                            <p className="text-sm text-gray-500 mt-1">
                              Show warning when {testData.warningTime} minutes
                              remain
                            </p>
                          </div>
                        </div>
                      </div>
                    )}
                  </div>

                  {/* Question Order */}
                  <div className="space-y-4">
                    <div className="flex items-center justify-between">
                      <div className="space-y-0.5">
                        <Label className="text-gray-700 font-medium flex items-center">
                          <Shuffle className="h-4 w-4 mr-2" />
                          Randomize Questions
                        </Label>
                        <p className="text-sm text-gray-500">
                          Shuffle question order for each student
                        </p>
                      </div>
                      <Switch
                        checked={testData.shuffleQuestions}
                        onCheckedChange={(checked) =>
                          handleTestInfoChange("shuffleQuestions", checked)
                        }
                      />
                    </div>

                    <div className="flex items-center justify-between">
                      <div className="space-y-0.5">
                        <Label className="text-gray-700 font-medium">
                          Randomize Answer Options
                        </Label>
                        <p className="text-sm text-gray-500">
                          Shuffle answer choices in multiple choice questions
                        </p>
                      </div>
                      <Switch
                        checked={testData.shuffleAnswers}
                        onCheckedChange={(checked) =>
                          handleTestInfoChange("shuffleAnswers", checked)
                        }
                      />
                    </div>
                  </div>

                  {/* Question Picker */}
                  <div className="flex items-center justify-between">
                    <div className="space-y-0.5">
                      <Label className="text-gray-700 font-medium">
                        Show Question Picker
                      </Label>
                      <p className="text-sm text-gray-500">
                        Allow students to see and jump to specific questions
                      </p>
                    </div>
                    <Switch
                      checked={testData.allowQuestionPicker}
                      onCheckedChange={(checked) =>
                        handleTestInfoChange("allowQuestionPicker", checked)
                      }
                      disabled={testData.navigationMode === "sequential"}
                    />
                  </div>

                  {/* Additional Settings */}
                  <div className="space-y-4">
                    <div className="flex items-center justify-between">
                      <div className="space-y-0.5">
                        <Label className="text-gray-700 font-medium">
                          Show Progress Bar
                        </Label>
                        <p className="text-sm text-gray-500">
                          Display completion progress to students
                        </p>
                      </div>
                      <Switch
                        checked={testData.showProgress}
                        onCheckedChange={(checked) =>
                          handleTestInfoChange("showProgress", checked)
                        }
                      />
                    </div>

                    <div className="flex items-center justify-between">
                      <div className="space-y-0.5">
                        <Label className="text-gray-700 font-medium">
                          Allow Pause
                        </Label>
                        <p className="text-sm text-gray-500">
                          Let students pause and resume the quiz
                        </p>
                      </div>
                      <Switch
                        checked={testData.allowPause}
                        onCheckedChange={(checked) =>
                          handleTestInfoChange("allowPause", checked)
                        }
                        disabled={testData.hasTimer}
                      />
                    </div>
                  </div>

                  {/* Attempt and Scoring Settings */}
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <Label className="text-gray-700">Maximum Attempts</Label>
                      <Input
                        type="number"
                        min="1"
                        max="10"
                        value={testData.maxAttempts}
                        onChange={(e) =>
                          handleTestInfoChange(
                            "maxAttempts",
                            Number(e.target.value)
                          )
                        }
                        className="focus:border-teal-500 focus:ring-teal-500"
                      />
                      <p className="text-sm text-gray-500 mt-1">
                        Number of times students can retake the quiz
                      </p>
                    </div>
                    <div>
                      <Label className="text-gray-700">Passing Score (%)</Label>
                      <Input
                        type="number"
                        min="0"
                        max="100"
                        value={testData.passingScore}
                        onChange={(e) =>
                          handleTestInfoChange(
                            "passingScore",
                            Number(e.target.value)
                          )
                        }
                        className="focus:border-teal-500 focus:ring-teal-500"
                      />
                      <p className="text-sm text-gray-500 mt-1">
                        Minimum score required to pass
                      </p>
                    </div>
                  </div>
                </CardContent>
              </Card>
            </div>

            {/* Sidebar for Settings Tab */}
            <div className="space-y-6">
              {/* Quick Stats */}
              <Card className="border-teal-100">
                <CardHeader>
                  <CardTitle className="text-lg">Test Overview</CardTitle>
                </CardHeader>
                <CardContent className="space-y-4">
                  <div className="flex items-center justify-between">
                    <span className="text-gray-600">Questions</span>
                    <span className="font-semibold">
                      {testData.questions.length}
                    </span>
                  </div>
                  <div className="flex items-center justify-between">
                    <span className="text-gray-600">Total Points</span>
                    <span className="font-semibold">
                      {testData.totalPoints}
                    </span>
                  </div>
                  <div className="flex items-center justify-between">
                    <span className="text-gray-600">Est. Duration</span>
                    <span className="font-semibold">
                      {testData.estimatedDuration} min
                    </span>
                  </div>
                  <div className="flex items-center justify-between">
                    <span className="text-gray-600">Avg. Points</span>
                    <span className="font-semibold">
                      {testData.questions.length > 0
                        ? (
                            testData.totalPoints / testData.questions.length
                          ).toFixed(1)
                        : 0}
                    </span>
                  </div>
                  <div className="flex items-center justify-between">
                    <span className="text-gray-600">Navigation</span>
                    <span className="font-semibold text-xs">
                      {testData.navigationMode === "sequential"
                        ? "Sequential"
                        : testData.navigationMode === "back-only"
                        ? "Back Only"
                        : "Free"}
                    </span>
                  </div>
                  <div className="flex items-center justify-between">
                    <span className="text-gray-600">Timer</span>
                    <span className="font-semibold">
                      {testData.hasTimer ? `${testData.timeLimit}m` : "None"}
                    </span>
                  </div>
                </CardContent>
              </Card>

              {/* Quick Actions */}
              <Card className="border-gray-200">
                <CardHeader>
                  <CardTitle className="text-lg">Quick Actions</CardTitle>
                </CardHeader>
                <CardContent className="space-y-3">
                  <Button
                    onClick={() => setActiveTab("questions")}
                    className="w-full border-teal-500 text-teal-600 hover:bg-teal-50 bg-white border"
                  >
                    <FileText className="h-4 w-4 mr-2" />
                    Manage Questions
                  </Button>

                  <Dialog open={isPreviewOpen} onOpenChange={setIsPreviewOpen}>
                    <DialogTrigger asChild>
                      <Button
                        onClick={openPreview}
                        disabled={testData.questions.length === 0}
                        className="w-full border-gray-400 text-gray-600 hover:bg-gray-50 disabled:opacity-50 bg-white border"
                      >
                        <Eye className="h-4 w-4 mr-2" />
                        Preview Test
                      </Button>
                    </DialogTrigger>
                    <DialogContent className="max-w-6xl max-h-[90vh] overflow-y-auto p-0">
                      <div className="p-6">{renderPreviewContent()}</div>
                    </DialogContent>
                  </Dialog>

                  <Button
                    onClick={saveTest}
                    disabled={
                      testData.questions.length === 0 ||
                      !testData.name.trim() ||
                      isSaving
                    }
                    className="w-full bg-teal-500 hover:bg-teal-600 text-white disabled:opacity-50"
                  >
                    {isSaving ? (
                      <>
                        <Clock className="h-4 w-4 mr-2 animate-spin" />
                        Saving...
                      </>
                    ) : (
                      <>
                        <Save className="h-4 w-4 mr-2" />
                        Save Test
                      </>
                    )}
                  </Button>
                </CardContent>
              </Card>

              {/* Tips */}
              <Card className="border-blue-100 bg-blue-50">
                <CardHeader>
                  <CardTitle className="text-lg text-blue-800">
                    ðŸ’¡ Settings Tips
                  </CardTitle>
                </CardHeader>
                <CardContent className="text-sm text-blue-700 space-y-2">
                  <p>â€¢ Use sequential mode for formal assessments</p>
                  <p>â€¢ Enable timers for standardized testing</p>
                  <p>â€¢ Shuffle questions to prevent cheating</p>
                  <p>â€¢ Set appropriate passing scores</p>
                  <p>â€¢ Configure navigation based on test type</p>
                  <p>â€¢ Test settings are auto-saved</p>
                </CardContent>
              </Card>
            </div>
          </div>
        </TabsContent>

        <TabsContent value="questions" className="space-y-0">
          <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
            {/* Questions Section */}
            <div className="lg:col-span-2">
              <Card className="border-gray-200">
                <CardHeader className="flex flex-row items-center justify-between">
                  <div>
                    <CardTitle className="text-xl text-gray-800">
                      Questions ({testData.questions.length})
                    </CardTitle>
                    <p className="text-sm text-gray-500 mt-1">
                      Total Points: {testData.totalPoints} â€¢ Estimated Duration:{" "}
                      {testData.estimatedDuration} minutes
                    </p>
                  </div>
                  <div className="flex gap-2">
                    <Dialog
                      open={isLibraryOpen}
                      onOpenChange={setIsLibraryOpen}
                    >
                      <DialogTrigger asChild>
                        <Button
                          variant="outline"
                          className="border-teal-500 text-teal-600 hover:bg-teal-50"
                        >
                          <Library className="h-4 w-4 mr-2" />
                          Question Library
                        </Button>
                      </DialogTrigger>
                      <DialogContent className="max-w-4xl max-h-[80vh] overflow-y-auto">
                        <DialogHeader>
                          <DialogTitle>Question Library</DialogTitle>
                        </DialogHeader>
                        <div className="space-y-4">
                          {questionLibrary.map((question) => (
                            <Card key={question.id} className="border-gray-200">
                              <CardContent className="p-4">
                                <div className="flex items-start justify-between">
                                  <div className="flex-1">
                                    <div className="flex items-center space-x-2 mb-2">
                                      <Badge
                                        className={getDifficultyColor(
                                          question.difficulty
                                        )}
                                      >
                                        {question.difficulty}
                                      </Badge>
                                      <Badge variant="outline">
                                        {question.category}
                                      </Badge>
                                      <Badge variant="outline">
                                        {question.points} pts
                                      </Badge>
                                    </div>
                                    <p className="text-gray-700 mb-2">
                                      {question.text}
                                    </p>
                                    <div className="text-sm text-gray-500">
                                      Type: {question.type.replace("-", " ")}
                                    </div>
                                  </div>
                                  <Button
                                    size="sm"
                                    onClick={() => addFromLibrary(question)}
                                    className="bg-teal-600 hover:bg-teal-700 text-white"
                                  >
                                    <Plus className="h-4 w-4 mr-1" />
                                    Add
                                  </Button>
                                </div>
                              </CardContent>
                            </Card>
                          ))}
                        </div>
                      </DialogContent>
                    </Dialog>
                    <Button
                      onClick={openAddModal}
                      className="bg-teal-500 hover:bg-teal-600 text-white"
                    >
                      <Plus className="h-4 w-4 mr-2" />
                      Add Question
                    </Button>
                  </div>
                </CardHeader>
                <CardContent>
                  {testData.questions.length === 0 ? (
                    <div className="text-center py-8 text-gray-500">
                      <FileText className="h-12 w-12 mx-auto mb-4 text-gray-300" />
                      <p>No questions added yet.</p>
                      <p className="text-sm">
                        Start by adding questions or importing from the library.
                      </p>
                    </div>
                  ) : (
                    <div className="space-y-4">
                      {testData.questions.map((question, index) => (
                        <div
                          key={question.id}
                          className="bg-white shadow p-6 rounded border border-gray-200"
                        >
                          <div className="flex items-start justify-between">
                            <div className="flex items-start space-x-3 flex-1">
                              <div className="flex flex-col space-y-1">
                                <Button
                                  size="sm"
                                  variant="outline"
                                  onClick={() => moveQuestion(index, "up")}
                                  disabled={index === 0}
                                  className="h-6 w-6 p-0"
                                >
                                  <ChevronUp className="h-3 w-3" />
                                </Button>
                                <Button
                                  size="sm"
                                  variant="outline"
                                  onClick={() => moveQuestion(index, "down")}
                                  disabled={
                                    index === testData.questions.length - 1
                                  }
                                  className="h-6 w-6 p-0"
                                >
                                  <ChevronDown className="h-3 w-3" />
                                </Button>
                              </div>
                              <div className="flex-1">
                                <div className="flex items-center space-x-2 mb-3">
                                  <span className="font-medium text-gray-800">
                                    Question {index + 1}
                                  </span>
                                  <div className="w-6 h-6 bg-teal-100 rounded text-xs flex items-center justify-center text-teal-600 font-medium">
                                    {getQuestionTypeIcon(question.type)}
                                  </div>
                                  <Badge
                                    className={getDifficultyColor(
                                      question.difficulty
                                    )}
                                  >
                                    {question.difficulty}
                                  </Badge>
                                  <Badge variant="outline">
                                    {question.category}
                                  </Badge>
                                  <Badge variant="outline">
                                    {question.points} pts
                                  </Badge>
                                </div>

                                <p className="text-gray-700 mb-3 font-medium">
                                  {question.text}
                                </p>

                                {/* Media Display */}
                                <div className="flex items-center space-x-4 mb-3">
                                  {question.imageUrl && (
                                    <div className="flex items-center space-x-2">
                                      <img
                                        src={
                                          question.imageUrl ||
                                          "/placeholder.svg"
                                        }
                                        alt="Question image"
                                        className="w-12 h-12 object-cover rounded border"
                                      />
                                      <div className="text-sm text-blue-600 bg-blue-50 px-2 py-1 rounded">
                                        <ImageIcon className="h-4 w-4 mr-1 inline" />
                                        Image attached
                                      </div>
                                    </div>
                                  )}
                                  {question.audioUrl && (
                                    <div className="flex items-center text-sm text-purple-600 bg-purple-50 px-2 py-1 rounded">
                                      <Volume2 className="h-4 w-4 mr-1" />
                                      Audio attached
                                    </div>
                                  )}
                                </div>

                                {/* Question Type Specific Content */}
                                {question.type === "multiple-choice" &&
                                  question.options && (
                                    <div className="bg-gray-50 p-3 rounded-lg">
                                      <p className="text-sm font-medium text-gray-700 mb-2">
                                        Options:
                                      </p>
                                      <div className="space-y-1">
                                        {question.options.map(
                                          (option, optIndex) => (
                                            <div
                                              key={optIndex}
                                              className="flex items-center space-x-2"
                                            >
                                              <div
                                                className={`w-2 h-2 rounded-full ${
                                                  option.isCorrect
                                                    ? "bg-green-500"
                                                    : "bg-gray-300"
                                                }`}
                                              />
                                              <span
                                                className={`text-sm ${
                                                  option.isCorrect
                                                    ? "text-green-700 font-medium"
                                                    : "text-gray-600"
                                                }`}
                                              >
                                                {option.text}
                                              </span>
                                              {option.isCorrect && (
                                                <Badge
                                                  variant="outline"
                                                  className="text-green-600 border-green-300"
                                                >
                                                  Correct
                                                </Badge>
                                              )}
                                            </div>
                                          )
                                        )}
                                      </div>
                                    </div>
                                  )}

                                {question.type === "fill-in-the-blank" &&
                                  question.fillInBlanks && (
                                    <div className="bg-gray-50 p-3 rounded-lg">
                                      <p className="text-sm font-medium text-gray-700 mb-2">
                                        Fill-in-the-blank:
                                      </p>
                                      <p className="text-sm text-gray-600 mb-2">
                                        {question.fillInBlanks.text}
                                      </p>
                                      {question.fillInBlanks.blanks &&
                                        question.fillInBlanks.blanks.length >
                                          0 && (
                                          <div>
                                            <p className="text-sm font-medium text-gray-700 mb-1">
                                              Correct Answers:
                                            </p>
                                            <div className="flex flex-wrap gap-2">
                                              {question.fillInBlanks.blanks.map(
                                                (blank, blankIndex) => (
                                                  <Badge
                                                    key={blankIndex}
                                                    variant="outline"
                                                    className="text-green-600 border-green-300"
                                                  >
                                                    Blank {blankIndex + 1}:{" "}
                                                    {blank.answer}
                                                  </Badge>
                                                )
                                              )}
                                            </div>
                                          </div>
                                        )}
                                    </div>
                                  )}

                                {question.type === "true-false" && (
                                  <div className="bg-gray-50 p-3 rounded-lg">
                                    <p className="text-sm font-medium text-gray-700 mb-1">
                                      Correct Answer:
                                    </p>
                                    <Badge
                                      variant="outline"
                                      className="text-green-600 border-green-300"
                                    >
                                      {question.trueFalseAnswer
                                        ? "True"
                                        : "False"}
                                    </Badge>
                                  </div>
                                )}

                                {question.type === "pronunciation" && (
                                  <div className="bg-gray-50 p-3 rounded-lg">
                                    <p className="text-sm font-medium text-gray-700 mb-1">
                                      Text to pronounce:
                                    </p>
                                    <p className="text-sm text-gray-600 italic">
                                      "{question.pronunciationText}"
                                    </p>
                                  </div>
                                )}

                                {question.type === "listening" && (
                                  <div className="bg-gray-50 p-3 rounded-lg">
                                    <div className="flex items-center justify-between mb-2">
                                      <p className="text-sm font-medium text-gray-700">
                                        Listening Question
                                      </p>
                                      <Badge
                                        variant="outline"
                                        className="text-blue-600 border-blue-300"
                                      >
                                        Max: {question.maxListeningTime}s
                                      </Badge>
                                    </div>
                                    {question.options && (
                                      <div className="space-y-1">
                                        {question.options.map(
                                          (option, optIndex) => (
                                            <div
                                              key={optIndex}
                                              className="flex items-center space-x-2"
                                            >
                                              <div
                                                className={`w-2 h-2 rounded-full ${
                                                  option.isCorrect
                                                    ? "bg-green-500"
                                                    : "bg-gray-300"
                                                }`}
                                              />
                                              <span
                                                className={`text-sm ${
                                                  option.isCorrect
                                                    ? "text-green-700 font-medium"
                                                    : "text-gray-600"
                                                }`}
                                              >
                                                {option.text}
                                              </span>
                                              {option.isCorrect && (
                                                <Badge
                                                  variant="outline"
                                                  className="text-green-600 border-green-300"
                                                >
                                                  Correct
                                                </Badge>
                                              )}
                                            </div>
                                          )
                                        )}
                                      </div>
                                    )}
                                  </div>
                                )}
                              </div>
                            </div>
                            <div className="flex space-x-2 ml-4">
                              <Button
                                size="sm"
                                variant="outline"
                                onClick={() => openEditModal(question)}
                                className="border-teal-500 text-teal-600 hover:bg-teal-50"
                              >
                                <Edit className="h-4 w-4 mr-1" />
                                Edit
                              </Button>
                              <AlertDialog>
                                <AlertDialogTrigger asChild>
                                  <Button
                                    size="sm"
                                    variant="outline"
                                    className="border-red-400 text-red-600 hover:bg-red-50"
                                  >
                                    <Trash2 className="h-4 w-4 mr-1" />
                                    Delete
                                  </Button>
                                </AlertDialogTrigger>
                                <AlertDialogContent>
                                  <AlertDialogHeader>
                                    <AlertDialogTitle>
                                      Are you sure?
                                    </AlertDialogTitle>
                                    <AlertDialogDescription>
                                      This action cannot be undone. This will
                                      permanently delete the question.
                                    </AlertDialogDescription>
                                  </AlertDialogHeader>
                                  <AlertDialogFooter>
                                    <AlertDialogCancel>
                                      Cancel
                                    </AlertDialogCancel>
                                    <AlertDialogAction
                                      onClick={() =>
                                        deleteQuestion(question.id)
                                      }
                                      className="bg-red-600 hover:bg-red-700"
                                    >
                                      Delete
                                    </AlertDialogAction>
                                  </AlertDialogFooter>
                                </AlertDialogContent>
                              </AlertDialog>
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </CardContent>
              </Card>
            </div>

            {/* Sidebar for Questions Tab */}
            <div className="space-y-6">
              {/* Question Stats */}
              <Card className="border-teal-100">
                <CardHeader>
                  <CardTitle className="text-lg">Question Statistics</CardTitle>
                </CardHeader>
                <CardContent className="space-y-4">
                  <div className="flex items-center justify-between">
                    <span className="text-gray-600">Total Questions</span>
                    <span className="font-semibold">
                      {testData.questions.length}
                    </span>
                  </div>
                  <div className="flex items-center justify-between">
                    <span className="text-gray-600">Multiple Choice</span>
                    <span className="font-semibold">
                      {
                        testData.questions.filter(
                          (q) => q.type === "multiple-choice"
                        ).length
                      }
                    </span>
                  </div>
                  <div className="flex items-center justify-between">
                    <span className="text-gray-600">Fill in Blank</span>
                    <span className="font-semibold">
                      {
                        testData.questions.filter(
                          (q) => q.type === "fill-in-the-blank"
                        ).length
                      }
                    </span>
                  </div>
                  <div className="flex items-center justify-between">
                    <span className="text-gray-600">True/False</span>
                    <span className="font-semibold">
                      {
                        testData.questions.filter(
                          (q) => q.type === "true-false"
                        ).length
                      }
                    </span>
                  </div>
                  <div className="flex items-center justify-between">
                    <span className="text-gray-600">With Media</span>
                    <span className="font-semibold">
                      {
                        testData.questions.filter(
                          (q) => q.imageUrl || q.audioUrl
                        ).length
                      }
                    </span>
                  </div>
                </CardContent>
              </Card>

              {/* Quick Actions */}
              <Card className="border-gray-200">
                <CardHeader>
                  <CardTitle className="text-lg">Quick Actions</CardTitle>
                </CardHeader>
                <CardContent className="space-y-3">
                  <Button
                    onClick={() => setActiveTab("settings")}
                    className="w-full border-teal-500 text-teal-600 hover:bg-teal-50 bg-white border"
                  >
                    <Settings className="h-4 w-4 mr-2" />
                    Back to Settings
                  </Button>

                  <Dialog open={isPreviewOpen} onOpenChange={setIsPreviewOpen}>
                    <DialogTrigger asChild>
                      <Button
                        onClick={openPreview}
                        disabled={testData.questions.length === 0}
                        className="w-full border-gray-400 text-gray-600 hover:bg-gray-50 disabled:opacity-50 bg-white border"
                      >
                        <Eye className="h-4 w-4 mr-2" />
                        Preview Test
                      </Button>
                    </DialogTrigger>
                    <DialogContent className="max-w-6xl max-h-[90vh] overflow-y-auto p-0">
                      <div className="p-6">{renderPreviewContent()}</div>
                    </DialogContent>
                  </Dialog>

                  <Button
                    onClick={saveTest}
                    disabled={
                      testData.questions.length === 0 ||
                      !testData.name.trim() ||
                      isSaving
                    }
                    className="w-full bg-teal-500 hover:bg-teal-600 text-white disabled:opacity-50"
                  >
                    {isSaving ? (
                      <>
                        <Clock className="h-4 w-4 mr-2 animate-spin" />
                        Saving...
                      </>
                    ) : (
                      <>
                        <Save className="h-4 w-4 mr-2" />
                        Save Test
                      </>
                    )}
                  </Button>
                </CardContent>
              </Card>

              {/* Tips */}
              <Card className="border-blue-100 bg-blue-50">
                <CardHeader>
                  <CardTitle className="text-lg text-blue-800">
                    ðŸ’¡ Question Tips
                  </CardTitle>
                </CardHeader>
                <CardContent className="text-sm text-blue-700 space-y-2">
                  <p>â€¢ Mix different question types for variety</p>
                  <p>â€¢ Use multimedia to enhance engagement</p>
                  <p>â€¢ Set appropriate point values</p>
                  <p>â€¢ Organize questions by difficulty</p>
                  <p>â€¢ Preview questions before saving</p>
                  <p>â€¢ Questions are auto-saved</p>
                </CardContent>
              </Card>
            </div>
          </div>
        </TabsContent>
      </Tabs>

      {/* Question Form Modal */}
      <Dialog open={isModalOpen} onOpenChange={setIsModalOpen}>
        <DialogContent className="max-w-4xl max-h-[90vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle>
              {editingQuestion
                ? `Edit Question #${
                    testData.questions.findIndex(
                      (q) => q.id === editingQuestion.id
                    ) + 1
                  }`
                : "Add New Question"}
            </DialogTitle>
          </DialogHeader>

          {renderQuestionForm()}

          <div className="flex justify-end space-x-2 pt-4">
            <Button variant="outline" onClick={closeModal}>
              Cancel
            </Button>
            <Button
              onClick={saveQuestion}
              className="bg-teal-500 hover:bg-teal-600 text-white"
            >
              {editingQuestion ? "Update Question" : "Add Question"}
            </Button>
          </div>
        </DialogContent>
      </Dialog>
    </div>
  );
}

export default withAuth(CreateTestPage);
